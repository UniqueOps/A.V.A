#!/bin/bash
# Description: Domain DNS Health Checker
# Contributors: Casey McLaughlin

# Notes:
# http://www.thegeekstuff.com/2012/02/dig-command-examples

# KNOWN ISSUES
# - NONE

# Include Colors
eval "$(curl -ks https://raw.githubusercontent.com/UniqueOps/A.V.A/master/var/colors)";

# Let's ask the user for the domain we are testing
echo -e "\n$Color_Blue===============================$Color_Reset Email Troubleshoot Script $Color_Blue===============================$Color_Reset\n";
echo -e "What is the domain?"
read domain;
echo -e "\n$Color_Blue=========================================================================================$Color_Reset\n";

# Vairables
CheckDNS_Global_NS=$(dig ns +short $domain | sort | sed -e :a -e '$!N; s/\n/ | /; ta');                         # Global Name Servers 1
CheckDNS_Local_NS=$(dig ns +short @localhost $domain | sort | sed -e :a -e '$!N; s/\n/ | /; ta');               # Local Name Servers 1
CheckDNS_Global_A=$(dig a +short $domain | awk FNR==1);                                                         # Global A Record
CheckDNS_Local_A=$(dig a +short @localhost $domain | awk FNR==1);                                               # Local A Record
CheckDNS_Global_MX=$(dig mx +short $domain | awk 'FNR==1{print $2}');                                           # Global MX Record
CheckDNS_Local_MX=$(dig mx +short @localhost $domain | awk 'FNR==1{print $2}');                                 # Local MX Record
CheckDNS_Server_DomainOwner=$(/scripts/whoowns $domain);                                                        # cPanel Username
CheckDNS_Server_DomainIP=$(cat /var/cpanel/users/$CheckDNS_Server_DomainOwner | grep 'IP=' | cut -d '=' -f2);   # Assigned IP
CheckDNS_Registrar=$(whois -H $domain | awk 'FNR==8{$1=""; print $0}');                                         # Domain's Registrar

# Begin Parent Checklist
echo -e "$Color_Blue=====================$Color_Bold$Color_Reset Parent $Color_Blue=====================$Color_Reset\n";
echo -e "[--] Scan Performed On Server: $Core_Server_Hostname";
echo -e "[--] Server IP: $Core_Server_IP";
if [[ $CheckDNS_Registrar != "" ]]; then
echo -e "$Color_Green[OK]$Color_Reset Domain is registered.";
echo -e "[--] Domain Registrar:$CheckDNS_Registrar";
if [[ $CheckDNS_Global_NS != "" ]]; then
echo -e "$Color_Green[OK]$Color_Reset Global nameservers detected.";
echo -e "[--] Global Records: $CheckDNS_Global_NS";
# Begin Name Server Checklist
echo -e "\n$Color_Blue===================$Color_Bold$Color_Reset Nameserver $Color_Blue===================$Color_Reset\n";
if [[ $CheckDNS_Global_NS == *"cloudflare.com."* ]]; then
   echo -e "$Color_Red[!!]$Color_Reset Cloudflare services detected!";
   echo -e "[--] You may find nameserver and A record mismatching due to this!";
fi
if [[ $CheckDNS_Server_DomainOwner != "" ]]; then
  echo -e "$Color_Green[OK]$Color_Reset Local nameservers detected.";
  echo -e "[--] Local Records: $CheckDNS_Local_NS";
  if [[ $CheckDNS_Server_DomainOwner != "" ]]; then
    echo -e "$Color_Green[OK]$Color_Reset Domain is connected to a cPanel Account.";
    echo -e "[--] Account Owner: $CheckDNS_Server_DomainOwner";
    if [[ $CheckDNS_Local_NS != $CheckDNS_Global_NS ]]; then
      echo -e "$Color_Red[!!]$Color_Reset Local/Global nameserver mismatch detected!";
    else
      echo -e "$Color_Green[OK]$Color_Reset Local/Global nameservers match.";
    fi
    # Begin MX Record Checklist
    echo -e "\n$Color_Blue=======================$Color_Bold$Color_Reset MX $Color_Blue=======================$Color_Reset\n";
    if [[ $CheckDNS_Local_MX == $CheckDNS_Global_MX ]]; then
      echo -e "$Color_Green[OK]$Color_Reset Local/Global MX records match.";
      if [[ $CheckDNS_Global_MX == *"google.com"* ]]; then
        echo -e "[--] G-Suite Email Services Detected.";
      elif [[ $CheckDNS_Global_MX == *"outlook.com"* ]]; then
        echo -e "[--] Office 365 Email Services Detected.";
      elif [[ $CheckDNS_Global_MX == *"$domain"* ]]; then
        echo -e "$Color_Green[OK]$Color_Reset Local Email Services Detected.";
      else
        echo -e "$Color_Green[OK]$Color_Reset Remote Email Services Detected.";
      fi              
    else
      echo -e "$Color_Red[!!]$Color_Reset Local/Global MX records mismatch detected!";
      echo -e "$Color_Red[!!]$Color_Reset Local mail might not reach destination!";
    fi
    # Begin HTTP Record Checklist
    echo -e "\n$Color_Blue======================$Color_Bold$Color_Reset HTTP $Color_Blue======================$Color_Reset\n";
    if [[ $CheckDNS_Global_A != $CheckDNS_Server_DomainIP ]]; then
      if [[ $CheckDNS_Global_A != $Core_Server_IP ]]; then
        echo -e "$Color_Red[!!]$Color_Reset Domain is directing to an external server.";
      else
        echo -e "$Color_Red[!!]$Color_Reset Domain is not using assigned dedicated IP address.";
        echo -e "[--] $CheckDNS_Server_DomainIP";
      fi
      if [[ $CheckDNS_Global_A != $CheckDNS_Local_A ]]; then
        echo -e "$Color_Red[!!]$Color_Reset Global/Local A Record Mismatch!";
      else
        echo -e "$Color_Green[OK]$Color_Reset Global/Local A Records Match.";
      fi
    else
      echo -e "$Color_Green[OK]$Color_Reset Domain is correctly pointing to local server.";
    fi
  else	
    echo -e "[$Color_Red!!$Color_Reset] Not affiliated with any local cPanel Accounts!";
  fi            
else
  echo -e "$Color_Red[!!]$Color_Reset Local nameservers NOT detected.";
fi
else
echo -e "$Color_Red[!!]$Color_Reset Global nameservers NOT detected.";
fi
else
echo -e "$Color_Red[!!]$Color_Reset Not a registered domain!";
fi
echo "";
